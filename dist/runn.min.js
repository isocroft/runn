const causePropertyIsMissingConfirmed=()=>{var e;return!("cause"in Error("test message",{cause:"[test cause]"}))},hasWebkitMutationObserverAPI=()=>{if("undefined"==typeof window)return!1;try{if(void 0!==window.WebKitMutationObserver)return!0}catch{}return!1},stackPropertyIsDataPropertyOnErrorInstance=(e=null)=>{if(e&&e instanceof Error)return"stack"in e;let r=Object.getOwnPropertyDescriptor(Error.prototype,"stack");return!("stack"in Error("test message"))&&void 0===r},canPatchErrorStackPropertyWithErrorCauses=()=>-1===Error("test message").toString().toLowerCase().indexOf("cause"),patchEventTargetOnGlobalObject=()=>{"undefined"==typeof window&&"undefined"!=typeof process&&(process.window=new EventTarget)},patchErrorPrototypeIfCausePropertyIsMissing=()=>{causePropertyIsMissingConfirmed()&&Object.defineProperty(Error.prototype,"cause",{configurable:!0,enumerable:!1,get(){return this._cause},set(e){this._cause=e}})},patchErrorValueOfMethodIfCauseIsMissingFromErrorStackTrace=()=>{canPatchErrorStackPropertyWithErrorCauses()&&(Error.prototype.valueOf=function e(){let r=this.stack,t=this.cause,n="",a=0,s=!stackPropertyIsDataPropertyOnErrorInstance(this),o=hasWebkitMutationObserverAPI(),i=s||o?/((?:global code)?@(?:anonymous|[a-zA-Z0-9-_)(\]\[\.]):\d{1,}:\d{1,}(?=))/m:/(at (?:<anonymous>|[a-zA-Z0-9-_\)\(\]\[\.]):\d{1,}:\d{1,}(?=))/m;for(;t;){++a;let c=Array(a).fill("	").join("");""===n?n+=r.replace(i,"reason: "+(t instanceof Error?t.stack.replace(i,`${c}$1`):JSON.stringify(t))):n+=n.replace(i,"reason: "+(t instanceof Error?t.stack.replace(i,`${c}$1`):JSON.stringify(t))),t=t instanceof Error?t.cause:null}return""!==n&&(this.stack=n),this})},isErrorObject=e=>e&&e instanceof Error,isNotErrorObject=e=>!e||!(e instanceof Error),isPromiseObject=e=>null!=e&&e instanceof Object&&Boolean("function"==typeof e.then&&("[object Promise]"===Object.prototype.toString.call(e)||"Promise"===e.constructor.name)),isNotPromiseObject=e=>!isPromiseObject(e);patchEventTargetOnGlobalObject(),patchErrorPrototypeIfCausePropertyIsMissing(),patchErrorValueOfMethodIfCauseIsMissingFromErrorStackTrace(),runn.$$groupAll=function(...e){var r;return Promise.all(e).then((r=promise.map(e=>e.__name),e=>Promise.resolve(e.reduce((e,t,n)=>(e[r[n]]=t,e),{})))).catch(e=>{let r=this.$$sync;null!==r&&"object"==typeof r&&"function"==typeof r.addWaitError&&r.addWaitError(e)})},runn.$$dispatchErrorEvent=e=>{let r=new Event("log.promise.error_");r.error=e,r.timestampId=Date.now(),"undefined"==typeof window?"undefined"!=typeof process&&process.window.dispatchEvent(r):window.dispatchEvent(r)};class Deffered{constructor(e,r,t,n,a){let s=r;isNotErrorObject(r)&&(s="string"==typeof r?Error(r):Error("Something went wrong: "+JSON.stringify(r))),this._promise=e,this.mainError=s,this._taskFnName=n,this.syncObject=t,this.augumentError=a}_patchErrorObjectAndDispatchToLogger(e){let r=new Event("log.promise.error_");this.mainError.cause=e;let t=this.mainError.valueOf().stack,n=t.indexOf("\n");return this.mainError.stack=this.augumentError.stack.replace(/^Error(?:[^\n]*)\n/,t.substring(0,n)).replace(/\b(?:[\s]*)(at runn \((?:<anonymous>|[a-zA-Z0-9-_\)\(\]\[\.]):\d{1,}:\d{1,}\))(?:.*)/,"cause"in e?"\n		$1":"\n	$1").replace("runn",this._taskFnName).trim()+t.substring(n+1),r.error=this.mainError,r.timestampId=Date.now(),"undefined"==typeof window?"undefined"!=typeof process&&process.window.dispatchEvent(r):window.dispatchEvent(r),this.mainError}_normalizeReturnValuesOrError(e,r,t){if(e instanceof Deffered)return e;if("<no error>"===r){let n=Promise.resolve(e);return n.__name=t,new Deffered(n,this.mainError,this.syncObject,t,this.augumentError)}let a=r;return isNotErrorObject(r)&&(a="string"==typeof r?Error(r):Error("Something went wrong: "+JSON.stringify(r))),($promise=Promise.reject(a)).__name=t,new Deffered($promise,this.mainError,this.syncObject,t,this.augumentError)}then(e){return"function"!=typeof e?this._promise.catch(e=>this._patchErrorObjectAndDispatchToLogger(e)):new Deffered(this._promise.then(r=>{let t,n="<no error>";try{t=e.call(null,r)}catch(a){n=a}return isPromiseObject(t)?(t.__name=e.name,new Deffered(t,this.mainError,this.syncObject,e.name,this.augumentError)):this._normalizeReturnValuesOrError(t,n,e.name)},r=>{let t=Promise.reject(r);return t.__name=e.name,new Deffered(t,this.mainError,this.syncObject,e.name,this.augumentError)}),this.mainError,this.syncObject,this._taskFnName,this.augumentError)}die(){return this.then().catch(e=>{let r=this.syncObject;try{throw e}finally{r=null,this._promise=null,this._taskFnName=null,this.augumentError=null}})}end(){let e=this.then().catch(e=>{let r=this.syncObject;return null!==r&&"object"==typeof r&&"function"==typeof r.realeaseFromWait&&(r.addWaitError(e),r.realeaseFromWait(this._taskFnName)),e});return e.__name=this._promise.__name,e}}function runn(e=()=>Promise.resolve(null)){let r=null,t=null,n=()=>{let e={name:"Error",message:""};if("captureStackTrace"in Error)Error.captureStackTrace(e,n),r=e;else try{throw Error("")}catch(t){r=t}};n();let a=runn.$$sync;null!==a&&"object"==typeof a&&"function"==typeof a.addToWait&&a.addToWait(e.name);try{t=e()}catch(s){t=s}return{get getResult(){if(isNotPromiseObject(t))return{asA:{get promise(){return console.warn(`'${e.name}(...)' did not return a promise`),t.__name=e.name,Promise.resolve(t)},get value(){if(isErrorObject(t)){let o=Error(`'${e.name}(...)' did not return a valid value`);throw o.cause=t.valueOf(),o}return t}},orThrow(n){if(isErrorObject(t)){let a=Promise.reject(t.valueOf());return a.__name=e.name,new Deffered(a,n,runn.$$sync,e.name,r)}let s=Promise.resolve(t);return s.__name=e.name,new Deffered(s,n,runn.$$sync,e.name,r)}};return{asA:{get promise(){return t.__name=e.name,t},get value(){throw Error(`'${e.name}(...)' returned a promise`)}},orThrow:n=>(t.__name=e.name,new Deffered(t,n,runn.$$sync,e.name,r))}}}}
